---
title: "Airbnb_8"
output: html_document
---

```{r load_packages, warning=FALSE, message=FALSE, echo=FALSE}

list.of.packages <- c("ggplot2", "Rcpp", "tidyverse", "mosaic", "ggfortify", "moderndive", "janitor", "huxtable", "here", "broom", "skimr", "GGally", "car", "vroom")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

library(tidyverse)
library(mosaic)
library(ggfortify)
library(moderndive)
library(janitor)
library(huxtable)
library(here)
library(broom)
library(skimr)
library(GGally)
library(car)
library(vroom)
library(GGally)
library(leaflet)
```

price = cost per night

cleaning_fee: cleaning fee

extra_people: charge for having more than 1 person

property_type: type of accommodation (House, Apartment, etc.)

room_type:

Entire home/apt (guests have entire place to themselves)
Private room (Guests have private room to sleep, all other rooms shared)
Shared room (Guests sleep in room shared with others)
number_of_reviews: Total number of reviews for the listing

review_scores_rating: Average review score (0 - 100)

longitude , latitude: geographical coordinates to help us locate the listing

neighbourhood*: three variables on a few major neighbourhoods in each city

```{r cars, cache=TRUE}
listings <- vroom("http://data.insideairbnb.com/denmark/hovedstaden/copenhagen/2020-06-26/data/listings.csv.gz") %>% 
    #get the listings for Copenhagen
    clean_names()  
```



```{r, exploration, echo=FALSE, cache=TRUE}
# Looking at the raw values
glimpse(listings) 

#Computing summary statistics of the variables of interest, or finding NAs
skim(listings) 

```

#EDA

We tried first to convert some of the data from characters to numeric (i.e “$176.00”--. 176)

```{r cleaning data,echo=FALSE}
# make price into a numeric variable
listings$price = as.numeric(gsub("[\\$,]", "", listings$price)) 

# make cleaning fee into a numeric variable
listings$cleaning_fee = as.numeric(gsub("[\\$,]", "", listings$cleaning_fee)) 

# make extra people a numeric variable
listings$extra_people = as.numeric(gsub("[\\$,]", "", listings$extra_people)) 


#Changes NA cleaning fee values to 0, because assuming that 0 is meant for NA
listings <- listings %>%   
  mutate(cleaning_fee = case_when(
    is.na(cleaning_fee) ~ 0, 
    TRUE ~ cleaning_fee
  ))

#create a list of property types and the count
listings%>% 
  group_by(property_type)%>%
  summarise(count= n())%>%
  arrange(desc(count))

#Taking top 4 property_type and creating a new column and assigning property_type in groups
listings <- listings %>%
  mutate(prop_type_simplified = case_when(
    property_type %in% c("Apartment","Condominium", "House","Townhouse") ~ property_type, 
    TRUE ~ "Other"
  ))

#check if all the variables are in the correct type
skim(listings) 

```
```{r filtering, echo=FALSE}

#displaying table with the count in descending order for the minimum nights
listings%>%     
  group_by(minimum_nights)%>%
  summarise(count= n())%>%
  arrange(desc(count))

#Filtering the airbnb data so that it only includes observations less than or equal to 4
listings<-listings%>%
  filter(minimum_nights <= 4)

```
> The most common values are 2,3,1,4,5.That means renting for a five days or less.
We see that there is a dramatic decrease of the number of listing from 5 days and above and this may be due to the fact that people staying for lomger periods are not here for travel purposes but for other reasons such as work, living etc.


```{r, echo=FALSE}

leaflet(data = filter(listings, minimum_nights <= 4)) %>% 
  addProviderTiles("OpenStreetMap.Mapnik") %>% 
  addCircleMarkers(lng = ~longitude, 
                   lat = ~latitude, 
                   radius = 1,
                   fillOpacity = 0.4, 
                   popup = ~listing_url,
                   label = ~property_type,
                   clusterOptions = markerClusterOptions()
                  )


```
# REGRESSION

```{r, echo=FALSE}

listings_numeric<- listings %>%
  select(price, accommodates, beds, guests_included, review_scores_rating, number_of_reviews,  bedrooms,  bathrooms,  cleaning_fee) 

listings_categorical<- listings %>%
  select(price, neighbourhood_cleansed, room_type,  room_type,  property_type,  host_is_superhost)


```
=======

## First questions

```{r}

listings$price = as.numeric(gsub("[\\$,]", "", listings$price)) # make price into a numeric variable
listings$cleaning_fee = as.numeric(gsub("[\\$,]", "", listings$cleaning_fee))
listings$extra_people = as.numeric(gsub("[\\$,]", "", listings$extra_people))
listings$guests_included = as.numeric(gsub("[\\$,]", "", listings$guests_included))

listings <- listings %>%
  mutate(cleaning_fee = case_when(
    is.na(cleaning_fee) ~ 0, 
    TRUE ~ cleaning_fee
  ))

listings <- listings %>%
  mutate(price = case_when(
    is.na(price) ~ 0, 
    TRUE ~ price
  ))

listings <- listings %>%
  mutate(extra_people = case_when(
    is.na(extra_people) ~ 0, 
    TRUE ~ extra_people
  ))

listings <- listings %>%
  mutate(guests_included = case_when(
    is.na(guests_included) ~ 0, 
    TRUE ~ guests_included
  ))



# create new variable for 4 nights using price, guests_included, cleaning_fee and extra_people
listings_new <- listings %>%
  mutate(price_4_nights = 
           ifelse(guests_included <= 1,
                  (price + extra_people) * 4 + cleaning_fee,
                  (price) * 4 + cleaning_fee))
  
#model_1<-lm(price_4_nights~cleaning_fee,data=listings_new)
#model_1 %>% tidy(conf.int=TRUE)
#model_1 %>% glance()


```

```{r,fig.width=20}

# density plots for price_4_nights
density.default(listings_new$price_4_nights)

# plot density of price_4_nights
ggplot(listings_new,aes(x=price_4_nights))+
  geom_density() +
  geom_vline(xintercept = density(listings_new$price_4_nights)$x[which.max(density(listings_new$price_4_nights)$y)])

# plot density of log(price_4_nights)
ggplot(listings_new,aes(x=log(price_4_nights)))+
  geom_density()

# calculate maximum (most often?) occuring price 4 nights value is :
max_p4n<-density(listings_new$price_4_nights)$x[which.max(density(listings_new$price_4_nights)$y)]

max_p4n

```

Answer: we should use variable log(price_4_nights). Looking at the desity plots of
price_4_nights and log(price_4_nights), we can see clearly that log(price_4_nights) is more close to a normal distribution, while most values in price_4_nights are cramped within a very small range(what function is it called?????)


### Model 1
```{r}

# create the new variable of log(price_4_nights)
listings_log <- listings_new %>%
  mutate(price_4_nights_log = log10(price_4_nights)) 
  

# create  model1 of price_4_nights with review_scores_ratings
model1<-lm(price_4_nights_log ~
              prop_type_simplified +
              number_of_reviews +
              review_scores_rating +
             NULL, 
            data = listings_log)
model1 %>% tidy(conf.int=TRUE)
model1 %>% glance()
car::vif(model1)

```
Interpret the coefficient review_scores_rating in terms of price_4_nights:
for every increase in rating by 1 point, the price goes up by 0.0023$ ???

Interpret the coefficient of prop_type_simplified in terms of price_4_nights:

### Model 2
```{r}
# create model2 with adding bathrooms, bedrooms, beds, accomodates to model 1
model2<-lm(price_4_nights_log ~
             prop_type_simplified +
             number_of_reviews +
             review_scores_rating +
             room_type +
             NULL, 
            data = listings_log)
model2 %>% tidy(conf.int=TRUE)
model2 %>% glance()

car::vif(model2)

```

Interpret if if room_type is a significant predictor 
It is 

Model 2: 24% 


# Additional questions
### Model 3
```{r}
# create model3 with adding bathrooms, bedrooms, beds, accommodates to model 3 -> test VIF
model3<-lm(price_4_nights_log ~
            prop_type_simplified +
             number_of_reviews +
             review_scores_rating +
             room_type + 
             bathrooms +
             bedrooms +
             beds + 
             accommodates +
             NULL, 
            data = listings_log)
model3 %>% tidy(conf.int=TRUE)
model3 %>% glance()

car::vif(model3)

```

The number of bathrooms, bedrooms, beds, and size of the house (accomodates) are all significant predictors of price_4_nights. However, there might be a problem with multi-collinearity since intuitively bathrooms, bedrooms and beds should have a positive relationship with size of the house. A further analysis on VIF shows that size of the house has slight correlation with other predictors but is within an acceotable range.

Model 3: 41%


### Model 4
```{r}
#
typeof(listings_log$host_is_superhost)

listings_log<-listings_log %>%
  mutate(superhost = ifelse(host_is_superhost == TRUE, 1,0))


# create model4 with adding host_is_superhost
model4<-lm(price_4_nights_log ~
            prop_type_simplified +
             number_of_reviews +
             review_scores_rating +
             room_type + 
             bathrooms +
             bedrooms +
             beds +
             accommodates +
             superhost +
             NULL,
            data = listings_log)
model4 %>% tidy(conf.int=TRUE)
model4 %>% glance()

car::vif(model4)

```

Most owners advertise the exact location of their listing (is_location_exact == TRUE), while a non-trivial proportion don’t. After controlling for other variables, is a listing’s exact location a significant predictor of price_4_nights?

### Model 5
```{r}
# create model5 with adding is_location_exact == TRUE
model5<-lm(price_4_nights_log ~
            prop_type_simplified +
             number_of_reviews +
             review_scores_rating +
             room_type +
             bathrooms +
             bedrooms +
             beds +
             accommodates +
             superhost +
             is_location_exact +
             NULL,
             data = listings_log)
model5 %>% tidy(conf.int=TRUE)
model5 %>% glance()

```


For all cities, there are 3 variables that relate to neighbourhoods: neighbourhood, neighbourhood_cleansed, and neighbourhood_group_cleansed. There are typically more than 20 neighbourhoods in each city, and it wouldn’t make sense to include them all in your model. Use your city knowledge, or ask someone with city knowledge, and see whether you can group neighbourhoods together so the majority of listings falls in fewer (5-6 max) geographical areas. You would thus need to create a new categorical variabale neighbourhood_simplified and determine whether location is a predictor of price_4_nights
```{r}

# create variable neighbourhood_simplified

# create model5 by adding neighbourhood_simplified
model6<-lm(price_4_nights_log ~
            prop_type_simplified +
             number_of_reviews +
             review_scores_rating +
             room_type +
             bathrooms +
             bedrooms +
             beds +
             accommodates +
             superhost +
             is_location_exact +
             #neighbourhood_simplified+
             NULL,
             data = listings_log)
model6 %>% tidy(conf.int=TRUE)
model6 %>% glance()
```


What is the effect of cancellation_policy on price_4_nights, after we control for other variables?
```{r}

# create model5 by adding cancellation_policy
model6<-lm(price_4_nights_log ~
            prop_type_simplified +
             number_of_reviews +
             review_scores_rating +
             room_type +
             bathrooms +
             bedrooms +
             beds +
             accommodates +
             superhost +
             is_location_exact +
             #neighbourhood_simplified +
             #cancellation_policy +
             NULL,
             data = listings_log)
model6 %>% tidy(conf.int=TRUE)
model6 %>% glance()
```



>>>>>>> 76f6fd0eeeaed16b6c1052aac00e857f3a7515e5
