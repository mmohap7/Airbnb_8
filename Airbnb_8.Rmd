---
title: "Airbnb_8"
output: html_document
---

```{r load_packages, warning=FALSE, message=FALSE, echo=FALSE}

list.of.packages <- c("ggplot2", "Rcpp", "tidyverse", "mosaic", "ggfortify", "moderndive", "janitor", "huxtable", "here", "broom", "skimr", "GGally", "car", "vroom")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

library(tidyverse)
library(mosaic)
library(ggfortify)
library(moderndive)
library(janitor)
library(huxtable)
library(here)
library(broom)
library(skimr)
library(GGally)
library(car)
library(vroom)
library(GGally)
library(leaflet)
```

price = cost per night

cleaning_fee: cleaning fee

extra_people: charge for having more than 1 person

property_type: type of accommodation (House, Apartment, etc.)

room_type:

Entire home/apt (guests have entire place to themselves)
Private room (Guests have private room to sleep, all other rooms shared)
Shared room (Guests sleep in room shared with others)
number_of_reviews: Total number of reviews for the listing

review_scores_rating: Average review score (0 - 100)

longitude , latitude: geographical coordinates to help us locate the listing

neighbourhood*: three variables on a few major neighbourhoods in each city

```{r cars}
listings <- vroom("http://data.insideairbnb.com/denmark/hovedstaden/copenhagen/2020-06-26/data/listings.csv.gz") %>% 
    #get the listings for Copenhagen
    clean_names()  
```



```{r, exploration, echo=FALSE}
# Looking at the raw values
glimpse(listings) 

#Computing summary statistics of the variables of interest, or finding NAs
skim(listings) 

```

#EDA

We tried first to convert some of the data from characters to numeric (i.e “$176.00”--. 176)

```{r Cleaning data,echo=FALSE}
# make price into a numeric variable
listings$price = as.numeric(gsub("[\\$,]", "", listings$price)) 

# make cleaning fee into a numeric variable
listings$cleaning_fee = as.numeric(gsub("[\\$,]", "", listings$cleaning_fee)) 

# make extra people a numeric variable
listings$extra_people = as.numeric(gsub("[\\$,]", "", listings$extra_people)) 


#Changes NA cleaning fee values to 0, because assuming that 0 is meant for NA
listings <- listings %>%   
  mutate(cleaning_fee = case_when(
    is.na(cleaning_fee) ~ 0, 
    TRUE ~ cleaning_fee
  ))

#create a list of property types and the count
listings%>% 
  group_by(property_type)%>%
  summarise(count= n())%>%
  arrange(desc(count))

#Taking top 4 property_type and creating a new column and assigning property_type in groups
listings <- listings %>%
  mutate(prop_type_simplified = case_when(
    property_type %in% c("Apartment","Condominium", "House","Townhouse") ~ property_type, 
    TRUE ~ "Other"
  ))

#check if all the variables are in the correct type
skim(listings) 

```
```{r filtering, echo=FALSE}

#displaying table with the count in descending order for the minimum nights
listings%>%     
  group_by(minimum_nights)%>%
  summarise(count= n())%>%
  arrange(desc(count))

#Filtering the airbnb data so that it only includes observations less than or equal to 4
listings_filtered_4nights <- listings %>%
  filter(minimum_nights <= 4)

```
> The most common values are 2,3,1,4,5.That means renting for a five days or less.
We see that there is a dramatic decrease of the number of listing from 5 days and above and this may be due to the fact that people staying for lomger periods are not here for travel purposes but for other reasons such as work, living etc.


```{r, echo=FALSE}

#Taking the filtered listings with a min of 4 nights and create a map of the apartments in Copenhagen
listings_filtered_4nights %>% 
leaflet() %>% 
  addProviderTiles("OpenStreetMap.Mapnik") %>% 
  addCircleMarkers(lng = ~longitude, 
                   lat = ~latitude, 
                   radius = 1,
                   fillOpacity = 0.4, 
                   popup = ~listing_url,
                   label = ~property_type,
                   #to get a better overview of the number and location of apartments in Copenhagen, a clustered map was chosen instead of the original point mapping.
                   clusterOptions = markerClusterOptions()
                  )
  

```
```{r}

#Calculated median price per night for each property type
average_per_proptype <- listings_filtered_4nights %>% 
  group_by(prop_type_simplified) %>% 
  summarise(median_price = median(price))

#Plotted a bar chart with median price per night for each property type
average_per_proptype %>% 
  ggplot(aes(
    x = reorder(prop_type_simplified, desc(median_price)),
    y = median_price
  )) +
  geom_col() +
  labs(
    title = "Median price per night per property type",
    x = "",
    y = "Median price per night",
    caption = "Source: AirBnB"
  )

#Calculated median price per night for each room type
median_per_roomtype <- listings_filtered_4nights %>% 
  group_by(room_type) %>% 
  summarise(median_price = median(price))

#Price per night for each room type
median_per_roomtype %>% 
  ggplot(aes(
    x = reorder(room_type, desc(median_price)),
    y = median_price
  )) +
  geom_col() +
  labs(
    title = "Median price per night per room type",
    x = "",
    y = "Median price per night",
    caption = "Source: AirBnB"
  )

listings<-listings%>%
  filter(minimum_nights == 4)

listings_matrix<- listings %>%
  select(price, square_feet ,bedrooms, bathrooms) 

ggpairs(listings_matrix, columns = 1:4)


```


# REGRESSION

```{r, echo=FALSE}

listings_numeric<- listings %>%
  select(price, accommodates, beds, guests_included, review_scores_rating, number_of_reviews,  bedrooms,  bathrooms,  cleaning_fee) 

listings_categorical<- listings %>%
  select(price, neighbourhood_cleansed, room_type,  room_type,  property_type,  host_is_superhost)





```
=======
## First questions

```{r}

listings$price = as.numeric(gsub("[\\$,]", "", listings$price)) # make price into a numeric variable
listings$cleaning_fee = as.numeric(gsub("[\\$,]", "", listings$cleaning_fee))
listings$extra_people = as.numeric(gsub("[\\$,]", "", listings$extra_people))
listings$guests_included = as.numeric(gsub("[\\$,]", "", listings$guests_included))

listings <- listings %>%
  mutate(cleaning_fee = case_when(
    is.na(cleaning_fee) ~ 0, 
    TRUE ~ cleaning_fee
  ))

listings <- listings %>%
  mutate(price = case_when(
    is.na(price) ~ 0, 
    TRUE ~ price
  ))

listings <- listings %>%
  mutate(extra_people = case_when(
    is.na(extra_people) ~ 0, 
    TRUE ~ extra_people
  ))

listings <- listings %>%
  mutate(guests_included = case_when(
    is.na(guests_included) ~ 0, 
    TRUE ~ guests_included
  ))



# create new variable for 4 nights using price, guests_included, cleaning_fee and extra_people
listings_new <- listings %>%
  mutate(price_4_nights = 
           ifelse(guests_included <= 1,
                  (price + extra_people) * 4 + cleaning_fee,
                  (price) * 4 + cleaning_fee))
  
#model_1<-lm(price_4_nights~cleaning_fee,data=listings_new)
#model_1 %>% tidy(conf.int=TRUE)
#model_1 %>% glance()




```

```{r,fig.width=20}

# density plots for price_4_nights
density.default(listings_new$price_4_nights)

# plot density of price_4_nights
ggplot(listings_new,aes(x=price_4_nights))+
  geom_density() +
  geom_vline(xintercept = density(listings_new$price_4_nights)$x[which.max(density(listings_new$price_4_nights)$y)])

# plot density of log(price_4_nights)
ggplot(listings_new,aes(x=log(price_4_nights)))+
  geom_density()

# calculate maximum (most often?) occuring price 4 nights value is :
max_p4n<-density(listings_new$price_4_nights)$x[which.max(density(listings_new$price_4_nights)$y)]

max_p4n

```
Explain why we continue to work with log(price_4_nights)


### Model 1
```{r}

# create the new variable of log(price_4_nights)
listings_log <- listings_new %>%
  mutate(price_4_nights_log = log10(price_4_nights)) 
  

# create  model1 of price_4_nights with review_scores_ratings
model1<-lm(price_4_nights_log ~
              prop_type_simplified +
              number_of_reviews +
              review_scores_rating, 
            data = listings_log)
model1 %>% tidy(conf.int=TRUE)
model1 %>% glance()

```
Interpret the coefficient review_scores_rating in terms of price_4_nights:
for every increase in rating by 1 point, the price goes up by 0.0023$ ???

Interpret the coefficient of prop_type_simplified in terms of price_4_nights:

### Model 2
```{r}
# create model2 with adding bathrooms, bedrooms, beds, accomodates to model 1
model2<-lm(price_4_nights_log ~
             prop_type_simplified +
             number_of_reviews +
             review_scores_rating +
             room_type, 
            data = listings_log)
model2 %>% tidy(conf.int=TRUE)
model2 %>% glance()

```

Interpret if if room_type is a significant predictor 
It is 

Model 2: 24% 


# Additional questions
### Model 3
```{r}
# create model3 with adding bathrooms, bedrooms, beds, accommodates to model 3 -> test VIF
model3<-lm(price_4_nights_log ~
            prop_type_simplified +
             number_of_reviews +
             review_scores_rating +
             room_type + 
             bathrooms +
             bedrooms +
             beds + 
             accommodates, 
            data = listings_log)
model3 %>% tidy(conf.int=TRUE)
model3 %>% glance()

```
Model 3: 41%


### Model 4
```{r}

typeof(listings_log$super_host)

listings_log %>%
  mutate(super_host = case_when(
    host_is_superhost == TRUE ~ 1, 
    host_is_superhost == FALSE ~ 0))

# create model4 with adding host_is_superhost
model4<-lm(price_4_nights_log ~
            prop_type_simplified +
             number_of_reviews +
             review_scores_rating +
             room_type + 
             bathrooms +
             bedrooms +
             beds +
             accommodates +
             # super_host, 
            data = listings_log)
model3 %>% tidy(conf.int=TRUE)
model3 %>% glance()

```



```{r}
# create model5 with adding is_location_exact == TRUE
# model3<-lm(price_4_nights_log ~
#               # prop_type_simplified +
#              number_of_reviews +
#              review_scores_rating +
#              room_type + 
#              bathrooms +
#              bedrooms +
#              beds + 
#              accommodates +
#              host_is_superhost +
#              # is_location_exact == TRUE, 
#             data = listings_log)
# model3 %>% tidy(conf.int=TRUE)
# model3 %>% glance()

```


>>>>>>> 76f6fd0eeeaed16b6c1052aac00e857f3a7515e5
